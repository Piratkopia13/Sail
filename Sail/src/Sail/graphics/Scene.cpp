#include "pch.h"
#include "Scene.h"
#include "../entities/components/Components.h"
#include "geometry/Model.h"
#include "light/LightSetup.h"
#include "../utils/Utils.h"
#include "Sail/Application.h"
#include "Sail/api/Renderer.h"
#include "Environment.h"
#include "material/OutlineMaterial.h"


Scene::Scene()  {
	m_renderer = std::unique_ptr<Renderer>(Renderer::Create(Renderer::DEFERRED));

	// Set up the environment
	m_environment = std::make_unique<Environment>();
}

Scene::~Scene() { }

void Scene::addEntity(Entity::SPtr entity) {
	m_entities.emplace_back(entity);
}

void Scene::draw(Camera& camera) {
	SAIL_PROFILE_FUNCTION();

	LightSetup lightSetup;
	m_renderer->setLightSetup(&lightSetup);

	m_renderer->begin(&camera, m_environment.get());

	{
		SAIL_PROFILE_SCOPE("Submit models");

		//// Submit skybox
		//{
		//	auto e = m_environment->getSkyboxEntity();
		//	auto model = e->getComponent<ModelComponent>();
		//	auto transform = e->getComponent<TransformComponent>();
		//	auto material = e->getComponent<MaterialComponent<>>();
		//	m_renderer->submit(model->getModel().get(), model->getModel()->getMesh(0)->getDefaultShader(), material->get(), transform->getMatrix());
		//}

		// Submit outline meshes first since they have to be drawn before the mesh they outline
		auto* outlineShader = &Application::getInstance()->getResourceManager().getShaderSet(Shaders::OutlineShader);
		for (Entity::SPtr& entity : m_entities) {
			if (entity->isSelectedInGui()) {
				auto model = entity->getComponent<ModelComponent>();
				auto transform = entity->getComponent<TransformComponent>();
				
				if (model && transform)
					m_renderer->submit(model->getModel().get(), outlineShader, &m_outlineMaterial, transform->getMatrix());
			}
		}

		for (Entity::SPtr& entity : m_entities) {

			// Add all lights to the lightSetup
			auto plComp = entity->getComponent<PointLightComponent>();
			if (plComp) lightSetup.addPointLight(plComp.get());
			auto dlComp = entity->getComponent<DirectionalLightComponent>();
			if (dlComp) lightSetup.setDirectionalLight(dlComp.get());

			auto model = entity->getComponent<ModelComponent>();
			auto transform = entity->getComponent<TransformComponent>();
			//if (!transform)	Logger::Error("Tried to draw entity that is missing a TransformComponent!");

			Material* material = nullptr;
			// Material is not required for rendering and may be set to nullptr - this is a lie
			if (auto materialComp = entity->getComponent<MaterialComponent<>>())
				material = materialComp->get();

				
			if (model && transform && material) {
				m_renderer->submit(model->getModel().get(), model->getModel()->getMesh(0)->getDefaultShader(), material, transform->getMatrix());
				entity->setIsBeingRendered(true);
			} else {
				// Indicate that the entity is not being rendered for some reason, this may be shown in the gui
				entity->setIsBeingRendered(false);
			}
		}
	}

	m_renderer->end();
	m_renderer->present();

	m_renderer->setLightSetup(nullptr);
}

std::vector<Entity::SPtr>& Scene::getEntites() {
	return m_entities;
}

Environment* Scene::getEnvironment() {
	return m_environment.get();
}
